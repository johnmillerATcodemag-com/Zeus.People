---
mode: agent
model: Claude Sonnet 4
tools:
  [
    create_file,
    insert_edit_into_file,
    replace_string_in_file,
    run_in_terminal,
    file_search,
    grep_search,
    read_file,
    semantic_search,
    azure_resources-query_azure_resource_graph,
    azure_applens-diagnose_resource,
  ]
description: Implement comprehensive monitoring, logging, and observability using Application Insights and Azure Monitor
---

# Monitoring and Observability Setup

Implement comprehensive monitoring, logging, and observability for the Academic Management System using Application Insights and Azure Monitor.

## Requirements

1. Configure Application Insights telemetry
2. Implement structured logging with Serilog
3. Add custom metrics for business events
4. Create dashboards for system health
5. Set up alerting for critical issues
6. Implement distributed tracing
7. Add performance monitoring
8. Create runbooks for incident response

## Monitoring Components

- Application Insights for application telemetry
- Log Analytics for centralized logging
- Azure Monitor for infrastructure metrics
- Custom dashboards for business metrics
- Alert rules for SLA violations
- Performance counters for optimization

## Key Metrics to Monitor

- API response times and error rates
- Database performance and connection health
- Service Bus message processing rates
- Business rule violation counts
- User authentication and authorization
- System resource utilization

## Alerting Rules

- High error rate (>5% in 5 minutes)
- Slow response times (>2 seconds 95th percentile)
- Database connection failures
- Service Bus message backlog
- Authentication failures
- Infrastructure resource issues

## Testing Instructions

- Deploy monitoring configuration to Azure
- Generate test traffic to validate telemetry
- Verify custom metrics appear in dashboards
- Test alert rules trigger correctly
- Confirm logs are structured and searchable
- Validate distributed tracing works across services
- Test incident response procedures

## Execution Plan (Automation & Validation)

| Task | Implementation Artifacts | How to Run | Success Criteria |
|------|--------------------------|------------|------------------|
| Deploy monitoring configuration | `infra/modules/appInsights.bicep`, `infra/modules/logAnalytics.bicep` | az deployment / azd up | App Insights + Log Analytics provisioned; connection string available in Key Vault | 
| Generate test traffic | `scripts/monitoring-validation.ps1` | `pwsh scripts/monitoring-validation.ps1 -BaseUrl https://your-api` | Requests + errors + latency buckets visible in AI (Requests, Dependencies, Custom Events) |
| Verify custom metrics | `CustomMetricsService`, `PerformanceMonitoringMiddleware` | KQL queries (see `MONITORING_VALIDATION_QUERIES.md`) | Custom metrics (Performance.*, Business.*, HttpRequests.*) return data |
| Test alert rules | Alert rule definitions (CLI/Bicep examples) | Run induced error/latency scenarios | Alerts fire (Activity Log + email/webhook) |
| Confirm structured logs | Serilog configuration in `Program.cs` | Query Log Analytics with KQL | Logs have consistent fields (Level, SourceContext, CorrelationId) |
| Validate distributed tracing | AI Request + Dependency telemetry, correlation headers | Trigger sample requests with dependency calls | End-to-end trace view links request -> dependencies |
| Test incident response | Runbooks `RUNBOOK_MONITORING_INCIDENTS.md` | Simulate outage/error spike | Runbook executed, MTTR recorded |

## Quick Start

```powershell
# 1. Deploy (if not already)
azd up  # or use Bicep deployment

# 2. Run traffic & scenarios
pwsh ./scripts/monitoring-validation.ps1 -BaseUrl "https://your-api" -DurationSeconds 120 -IncludeErrorScenarios -Verbose

# 3. Run KQL validation (copy from MONITORING_VALIDATION_QUERIES.md into Logs blade)

# 4. Trigger alert thresholds (force errors / latency)

# 5. Execute runbook steps in RUNBOOK_MONITORING_INCIDENTS.md
```

## Artifacts Added
- `scripts/monitoring-validation.ps1` - Synthetic traffic & scenario generator
- `MONITORING_VALIDATION_QUERIES.md` - KQL queries for telemetry validation
- `RUNBOOK_MONITORING_INCIDENTS.md` - Incident response procedures

## Additional Notes
- Correlation ID is exposed via `X-Correlation-ID` header; include in client logs for trace stitching.
- Health check noise is filtered by `CustomTelemetryProcessor`.
- Business metrics prefixed with `Business.`; performance with `Performance.`; HTTP classification under `HttpRequests.*`.

## Next Actions
1. Populate alert rules in Azure Monitor (deploy via Bicep or Portal)
2. Execute validation script against staging
3. Run KQL queries to confirm all telemetry dimensions
4. Document alert rule resource IDs & notification channels
5. Schedule quarterly runbook simulation
